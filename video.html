<html>
<head>
</head>
<body>
<button type="button" id="start-screen-btn">录屏</button>
<button type="button" id="start-camera-btn">打开摄像头</button>
<button type="button" id="stop-camera-btn" disabled>关闭摄像头</button>
录音：<input type="checkbox" id="audio"></input>
<button type="button" id="start-btn" disabled>开始录像</button>
<button type="button" id="stop-btn" disabled>停止录像</button>
<button type="button" id="auto-btn" disabled>自动录像</button>
<button type="button" id="play-btn" disabled>播放视频</button>
<button type="button" id="export-btn" disabled>导出视频</button>
时长：<input type="text" id="timeout" value="30">秒
<div class="container">
    <video width="100%" height="100%" controls></video>
    <div class="overlayText">
        <p id="topText"></p>
    </div>
</div>
<style>
.overlayText {
  position: absolute;
  top: 30%;
  left: 20%;
  z-index: 1;
}

#topText {
  color: red;
  font-size: 30px;
  align-self: center;
}
</style>

<script type="text/javascript">
var body = document.getElementById('start-screen-btn');
body.addEventListener("click",async function(){
    var stream = await navigator.mediaDevices.getDisplayMedia({video: true});

    var mime = MediaRecorder.isTypeSupported("video/webm; codecs=vp9") ?"video/webm; codecs=vp9" :"video/webm";
    var mediaRecorder = new MediaRecorder(stream, {mimeType: mime});

    //录制
    var chunks = [];
    mediaRecorder.addEventListener('dataavailable', function(e) {
    chunks.push(e.data)
    })

    //停止
    mediaRecorder.addEventListener('stop', function(){
    var blob = new Blob(chunks, {type: chunks[0].type});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'video.webm';
    a.click();
    })
    //手动启动
    mediaRecorder.start()
});

const startCameraBtn = document.querySelector('#start-camera-btn');  // 打开摄像头按钮
const stopCameraBtn = document.querySelector('#stop-camera-btn');
const startBtn = document.querySelector('#start-btn');  // 开始录像按钮
const stopBtn = document.querySelector('#stop-btn');  // 停止录像按钮
const autoBtn = document.querySelector('#auto-btn');  // 播放视频按钮
const playBtn = document.querySelector('#play-btn');  // 播放视频按钮
const exportBtn = document.querySelector('#export-btn');  // 导出视频按钮
const timeoutInput = document.querySelector('#timeout');  // 导出视频按钮
const videoEl = document.querySelector('video');  // 视频播放元素
const topText = document.querySelector('#topText');
const audio = document.querySelector('#audio');
let videoData = [];  // 存放视频数据
let  cameraStream = null;  // 存放媒体流
let mediaRecorder = null;  // 存放媒体录制对象

autoBtn.addEventListener('click', () => {
    startBtn.click();
    let timeout = timeoutInput.value;
    const inter = window.setInterval(() => {
        topText.innerText = '剩余 ' + --timeout + ' 秒';
    }, 1000)

    window.setTimeout(() => {
        window.clearInterval(inter);
        stopBtn.click();
        alert('finished');
        topText.innerText = '录制完成';
    }, timeoutInput.value * 1000)
})

stopCameraBtn.addEventListener('click', () => {
  window.localStream.getTracks().forEach(function(track) {
    track.stop();
  });
})
// 打开摄像头按钮点击
startCameraBtn.addEventListener('click', () => {
  // 申请视频和音频的参数
  const constraints = {
    audio: audio.checked,
    video: {
      width: 720,
      height: 360
    }
  };
  // 申请摄像头和麦克风权限
  navigator.mediaDevices.getUserMedia(constraints).then(stream => {
    cameraStream = stream;
    window.localStream = stream;
    // 禁用 video 的控制组件
    videoEl.controls = false;
    // 把媒体流传给 video 的 srcObject
    videoEl.srcObject = cameraStream;
    // 播放画面和声音
    videoEl.play();

    stopCameraBtn.disabled = false;
    startBtn.disabled = false;
    autoBtn.disabled = false;
  }).catch(info => {
    alert('错误' + info);
  });
});

// 开始录像按钮点击
startBtn.addEventListener('click', () => {
  // 创建媒体录制
  mediaRecorder = new MediaRecorder(cameraStream, {mimeType: 'video/webm'});
  // 开始录制
  mediaRecorder.start();

  // 处理视频数据
  mediaRecorder.addEventListener('dataavailable', ev => {
    videoData.push(ev.data);
  });

  // 录制停止事件
  mediaRecorder.addEventListener('stop', () => {
    videoData = new Blob(videoData);
    exportBtn.disabled = false;
  });
  stopBtn.disabled = false;
});

// 停止录像按钮点击
stopBtn.addEventListener('click', () => {
  mediaRecorder.stop();
});

// 播放视频点击
playBtn.addEventListener('click', () => {
  if (videoData === null) return false;
  // 清除 video 的媒体流
  videoEl.srcObject = null;
  // 把视频数据转为 URL 传给 video 的 src
  videoEl.src = URL.createObjectURL(videoData);
  // 播放视频
  videoEl.play();
  // 启用 video 的控制组件
  videoEl.controls = true;
  // 删除媒体流
  cameraStream = null;
});

// 导出视频按钮点击
exportBtn.addEventListener('click', () => {
  if (videoData === null) return false;
  const link = document.createElement('a');
  link.href = URL.createObjectURL(videoData);
  link.download = 'video.mp4';
  link.click();
});
</script>
</body>
</html>
